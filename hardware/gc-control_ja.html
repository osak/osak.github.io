<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../style_memoyoushi.css" />




<title>メモ用紙2.0 | 任天堂ゲームキューブ用コントローラーのピン配置</title>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-K7GK6FJ729"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-K7GK6FJ729');
</script>

</head>
<body>
<div id="header">
  <h1 class="title"><a href="../index_memoyoushi.html">メモ用紙2.0</a></h1>
  <address>osak.63 at_mark gmail.com</address>
</div>
<div id="body">
  <div id="menu">
    <ul>
      <li><a href="../about.html">About</a></li>
      <li><a href="../program/index.html">Program</a></li>
      <li><a href="../linux/index.html">Linux</a></li>
      <li><a href="index.html">Hardware</a></li>
      <li><a href="../trip/index.html">Trip</a></li>
      <li><a href="../food/index.html">Food</a></li>
      <li><a href="../other/index.html">Other</a></li>
      <li><a href="../diary/index.html">Diary</a></li>
    </ul>
  </div>

  <div id="main">
    <h2 id="section">任天堂ゲームキューブ用コントローラーのピン配置</h2>

<h3 id="section-1">この文書について</h3>

<p>この文書は，osa_kが <a href="http://www.int03.co.uk/crema/hardware/gamecube/gc-control.html">Nintendo Gamecube Controller
Pinout</a>
を翻訳したものです．
この日本語訳における責任は，すべてosa_kにあります．なにか訳の間違いなどあったら，連絡してもらえれば幸いです．</p>

<h3 id="section-2">任天堂ゲームキューブ用コントローラーのプロトコル</h3>

<p>最終更新：2004年3月8日（最初のバージョンは2002年12月11日）</p>

<p>これは単なる技術文書です。
もしも技術的なことに興味がなく、ただ単にゲームキューブのコントローラーをPCに繋ぐ簡単な手段が欲しいだけであれば、
すでに出来上がっているアダプタを使うのが良いでしょう。そのアダプタは
<a href="http://www.lik-sang.com/search.php?query=skillz+cube+connection">Skillz Cub Connection
USB</a>
と呼ばれるもので、私の知る限りでは
<a href="http://www.lik-sang.com/">Lik-Sang社</a> だけが取り扱っています。
これは、任天堂純正のゲームキューブコントローラーにしか使えないようです（Wavebirdや他のサードパーティ製のコントローラとは互換性がないようです）。</p>

<p>もしも非公式なハードウエア解析や分解のようなものに興味があるなら、読み進めてください。</p>

<h3 id="section-3">はじめに</h3>

<p>GCコントローラーは、独自の6ピンコネクタとスクリーンケーブルによってゲームキューブと繋がっています。
純正のコントローラーはこのうちの5ピンしか結線しておらず、また、データ通信には1ピンしか使っていないようです。
この文書に書かれているのは、マルチメーターとオシロスコープによる実験と経験から推定したピン配置の説明です。
よって、この情報の正確性は保証しませんし、自分の責任で使ってください。これはあくまでも、私が
<em>一番それらしいと思った</em> 推論です:)</p>

<p>もしこのページに追加してほしい有用な情報がありましたら、私にメールをください（連絡先はindexにあります）
<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> ．</p>

<p>James, 8th March 2004．</p>

<h3 id="section-4">コネクタのピン配置</h3>

<p>これはゲームキューブの前面から、ソケットを覗き込んだときの図です。番号付けは私のものです。</p>

<p><img src="img/gc-socke.gif" alt="image" /></p>

<table border="1">
<colgroup>
<col width="8%" />
<col width="5%" />
<col width="5%" />
<col width="82%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">ピン</th>
<th class="head">色</th>
<th class="head">J1</th>
<th class="head">機能</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>1</td>
<td>黄</td>
<td>2</td>
<td>5V電源(振動モータが使用)</td>
</tr>
<tr><td>2</td>
<td>赤</td>
<td>3</td>
<td>データライン：双方向，3.43Vプルアップ</td>
</tr>
<tr><td>3</td>
<td>緑</td>
<td>4</td>
<td>グランド</td>
</tr>
<tr><td>4</td>
<td>白</td>
<td>5</td>
<td>グランド(Skillzでは3番ピンと4番ピンがグランドを共有しています)</td>
</tr>
<tr><td>5</td>
<td>-</td>
<td>-</td>
<td>不明：純正品，Skillz共に結線されていません</td>
</tr>
<tr><td>6</td>
<td>青</td>
<td>1</td>
<td>ロジック用3.43V電源供給</td>
</tr>
<tr><td>7</td>
<td>黒</td>
<td>6</td>
<td>ケーブルのシールド・グランド．大抵は3番ピンと共通</td>
</tr>
</tbody>
</table>

<p>上の表は、一番左の数字が図のピン番号を表しています。
色は純正コントローラでのケーブルの色で（モデルによって異なるかもしれません）、5番ピンは使われていません。
3行目はコントローラー内部のコネクタに書いてあるピン番号です。特殊なねじ回しがあれば（もしくは即席の自作の道具があれば）見ることができます。
<a href="http://www.lik-sang.com/">Lik-Sang社</a> から購入することもできます <sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>
． 一番右の列は、それぞれのピンについて推測される機能です。</p>

<h4 id="section-5">どのピンが自作インターフェースに必要？</h4>

<p>私の試作品では、3番ピンと4番ピンを共通グランドとして、1番ピンには7805を用いて5Vを供給し、6番ピンには可変レギュレータで3.43Vを与えています。
他に結線しているのは2番ピンだけで、1Kのプルアップ抵抗を3.43Vラインとの間に噛ませています。
なお、Skillzのアダプターでは3.3Vのレギュレータを使っていたので、私の最初の設計ではやはり3.3Vを使うようになっていました。
おそらくここの正確性は大して重要ではないと思われます。
今の設計が3.43Vを使っているのは、ただ単にPAL <sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup>
用のゲームキューブで計った数値だからという理由です。</p>

<p><strong>注意：</strong>
これは言うまでもないことですが、もしもケーブルにこれらの電源や抵抗を繋いだ状態でゲームキューブに接続すると、
なんらかのダメージを与える可能性があります。この注意をするのは、このようにケーブルを改造すると事故を起こしやすいからです。
まず最初にコントローラーを抜いておくことを絶対に忘れないでください。</p>

<h3 id="section-6">電源供給と振動モーター</h3>

<p>コネクタには、ロジック用と思しき3.43Vの供給と、振動モーターに使われている5Vの供給用（おそらくロジックにも使われています）の二つの電源ラインがあります。
3番ピンのグランドと7番ピンのシールドは一緒に接続してください。</p>

<p>モーターに使われる5Vは常にオンで、制御はコントローラーに送るコマンドで行います。
つまり、コントローラーはモーターのOn/Off切り替えのために電源用トランジスタを内蔵していて、コンソールから制御します。
黄色の5Vラインは直接モーターの+ve端子に接続されていて、-ve端子はトランジスタに繋がっているようです。</p>

<p>コントローラーに消費される電流はまだ計っていません。</p>

<h3 id="section-7">シリアル通信</h3>

<p>コントローラーは双方向のデータ線（2番ピン、赤）を使って通信します。
信号は3.43Vのアクティブ・ハイで、プルアップ抵抗によってHighを保ちます。Lowにするときは、オープンコレクタのトランジスタで引き下げます。
通信はコンソールから24bitのビット列をコントローラーに送ると始まり、コントローラーは64bitでボタンとスティックの状態を返します。</p>

<p>私は最初、コントローラーの内部にプルアップ抵抗が入っていると思っていたのですが（計測すると745Ωでした）、
実際には私の試作品では3.43Vラインとデータ線の間に1Kのプルアップ抵抗をはさんでいます。</p>

<p>通信速度は、4us/bitより <em>少し速い</em> です。 Nintendo
64のコントローラーと同様に、Lowビットは3usのLowの後に1usのHigh、Highビットは1usのLowの後に3usのHighで表されます。
そう、まさにNintendo 64のコントローラーと同じです！</p>

<p><img src="img/timing00.gif" alt="image" /></p>

<p>ゲームキューブ本体やコントローラーがビット列を送るときは、一つの（Highの）ストップビットで終わります。
つまり、00000000を送るためには、実際には000000001を送るということです。</p>

<h4 id="section-8">タイミング計測</h4>

<p>最初は（2003年12月時点での文書）、タイミングは5us/bitくらいだと思っていたのですが、それはオシロスコープの分解能が不正確だったために誤っていました。
Philipp
Kastnerがストレージオシロスコープで計測したデータを送ってくれたのですが、そのデータでは4us/bitだったので、パラレルポートを用いて再計測することにしました。</p>

<p>パラレルポートを使って、通信の最初のHigh-&gt;Lowの立ち下がりから、コントローラーからの返答の最後のLow-&gt;Highの立ち上がりまでの時間を計測しました。
パラレルポートのサンプリングレートは1us/bitくらいで、誤差は±2usと考えられます。
10回連続して計った結果を平均すると、約348usでした。総ビット数が24+64=88bitとすると、3.95us/bitとなります。
ただし、コマンドを送信してからコントローラが返答するまでの時間は無視できるほど短いとしています。
このタイミングは、QueryPerformanceCounterをWindows2000、P4
2.8GHz、i875Pチップセットの環境で動かして得られたものです。</p>

<h4 id="section-9">コントローラーの検出</h4>

<p>コントローラーを挿していないとき、ゲームキューブは12ms毎に000000001を送ることでコントローラーを検出します。
下のオシロスコープの波形は、典型的な検出シーケンスを示しています（トリガーは立ち下がり）。
コントローラーを接続するとコントローラーがこれに返答するので、接続されたことを検知できます。
この最初の通信に何か有用な情報があるかどうかは、もっと調査が必要です（たとえば、どの種類のコントローラーが接続されたかなど）。</p>

<p><img src="img/gcprobe0.jpg" alt="image" /></p>

<h4 id="section-10">スティック・ボタンの取得</h4>

<p>純正コントローラーが接続されているとき、典型的には約6ms毎に更新要求が来ます。
実際には、更新間隔はゲームによって調整でき、それはフレームレートで決まっているのではないかと予想しています。
データの更新は348us程で完了します。まずコンソールから次のような24bitのビット列を送ります。</p>

<p>0100 0000 0000 0011 0000 0010</p>

<p>この後、コントローラーはすべてのボタンとスティックの位置情報をビット列で返します。その意味は次の表の通りです。
ボタンは左から右に、送信順に並べてあります（一番左のビットが一番最初に送られる、ということです）。</p>

<p>+—————+——+——+——+———-+——-+——-+——-+——-+
| <strong>Byte 0</strong>    | 0    | 0    | 0    | Start    | Y     | X     | B     | A     |
+—————+——+——+——+———-+——-+——-+——-+——-+
| <strong>Byte 1</strong>    | 1    | L    | R    | &gt; Z      | ↑ |   | ↓ | → | ←     |       |
+—————+——+——+——+———-+——-+——-+——-+——-+
| <strong>Byte 2</strong>    | ステ | ィッ | クの | X座標(8b | it)   |       |       |       |
+—————+——+——+——+———-+——-+——-+——-+——-+
| <strong>Byte 3</strong>    | ステ | ィッ | クの | Y座標(8b | it)   |       |       |       |
+—————+——+——+——+———-+——-+——-+——-+——-+
| <strong>Byte 4</strong>    | Cス  | ティ | ック | のX座標( | 8bit) |       |       |       |
+—————+——+——+——+———-+——-+——-+——-+——-+
| <strong>Byte 5</strong>    | Cス  | ティ | ック | のX座標( | 8bit) |       |       |       |
+—————+——+——+——+———-+——-+——-+——-+——-+
| <strong>Byte 6</strong>    | Lト  | リガ | ーの | 状態(8bi | t)    |       |       |       |
+—————+——+——+——+———-+——-+——-+——-+——-+
| <strong>Byte 7</strong>    | Rト  | リガ | ーの | 状態(8bi | t)    |       |       |       |
+—————+——+——+——+———-+——-+——-+——-+——-+</p>

<p>上の表で、L/RボタンはL/Rトリガが完全に押し込まれているか否かを表します。また、AとLの間のビットは常にHighになっています。
最初の3つの0は、ボタン操作では変化しません（私は少なくとも000と001がここに入っているのを見たことがあります）。</p>

<h4 id="section-11">振動</h4>

<p>コマンドの最後のビットは振動の制御です。このビットを1にすると振動モーターがOnになり、0にすると止まります。初期化は必要ありません。
コントローラーを繋げた直後から、24bitのコマンドを送ってコントローラーの状態を得たり振動させたりできます。</p>

<h4 id="section-12">その他の挙動</h4>

<p>24bitのコマンドの中には、コントローラーのリセットや，接続されているコントローラーの種類を得るための命令を示す部分があるようです。
他のコマンドを見つけるには、もっと詳細な実験が必要と思われます。</p>

<p>以前はコントローラーがコマンドに応答する前に15usの遅れがありました。しかし、最近の実験では
（以前とは違うコントローラーを使っています。おそらくコントローラーのバージョンで違うのでしょう）、この遅れはなくなっています。
これは、コントローラーの違いによるか、もしくはコントローラーへのコマンドの送信頻度によるものと考えています。
この遅れは、私が最初に実験した時ははっきりと出ていて、後に示す写真で見ることができます。</p>

<p>Skillzのアダプタの出力を調べているときは、L/Rトリガーからは4bitのデータしか返ってきていませんでした。
これは検証する必要がありますが、コントローラーは4bitと8bitの両方の分解能をサポートしているようです。
しかし、8bitが取れるのに誰がわざわざ4bitを欲しがるんでしょう？よく分かりません。</p>

<h4 id="section-13">オシロスコープではどのように見えるか</h4>

<p>オシロスコープやロジックアナライザが使えない人のために、私の使い古したオシロスコープで取った不鮮明な写真を載せます。
この画像で、Aは24bitのコマンドを送信し始めた点で、Bは64bitの返答の初めの点です。画質は非常に悪いですが、個々のビットは見て取れます。
また、コマンドと返答の間に遅れがあることが分かります。最近の実験では、この遅れは無くなっています。</p>

<p><img src="img/gcdata-s.jpg" alt="image" /></p>

<p>最後に、これが0100を送信したときの波形の拡大図です。</p>

<p><img src="img/gcbits00.jpg" alt="image" /></p>

<h4 id="section-14">非公式インターフェース</h4>

<p>以前、実験のために簡単な非公式インターフェースを作りました。
このインターフェースは、純正コントローラーから全部のボタン、スティック、L/Rトリガーの値を読めました（DOL-003とコントローラーの下部に書いてあります）。
サードパーティのコントローラー（MadCatz
MicroCon）でも試しましたが、これは動きませんでした。
しかしこれは、回路やタイミングのちょっとした調整でなんとかなると思います（有り体に言ってしまえば、このときはダメダメな実装でした）。</p>

<p>とにかく、コントローラーと会話できたし、振動させることもできました。さて、もっといい点は？そう、ソースコードがダウンロードできます。</p>

<h4 id="section-15">試作ソフトウエア</h4>

<p>まず初めに、これはWindows2000で開発されています。そして、今のところはi875チップセット上のP4
2.8GHzでのみ動作を確認しています。
幸いなことに、これは最低必須環境ではありません。が、遅いPCでタイミングを計ったときに、実際より長い時間を計測しても不思議ではありません。
もしもそういう現象が起きたら連絡してもらえれば、直せるかどうか調べてみます。</p>

<p>私がこれをリリースするのは、電子工作やソフトウエアの基本的な知識を持つなるべく多くの人に実験してもらいたいからです。
これはまだ実用にはできていません。つまり、汎用ドライバなどはありません。</p>

<p>このソフトを使うに当たって必要なのは、</p>

<blockquote>
  <ol>
    <li>手作りのハード（回路図は間もなく公開しますが、待ちきれない人や剛の者のために、ソースコード中にピン配置が書いてあります）。</li>
    <li>giveio デバイスドライバ</li>
    <li>鋼の精神：PCやコントローラーが壊れる危険を厭わない気構え :)</li>
  </ol>
</blockquote>

<p>このプログラムは、パラレルポート上のダイレクトI/Oで動きます。
通常この操作はWindows NT/2000/XPでは許可されていないので、 <strong>giveio</strong>
というドライバをインストールしてください。
ぐぐればすぐに見つかります（すぐにリンクを張りたいと思います）。
これはインストールされると（管理者権限が必要です）、プロテクトを破ってダイレクトI/Oを叩けるようにします。</p>

<p>一度 <strong>giveio</strong>
をインストールすると、要求されたとき自動的にgiveioサービスが立ち上がり、有効化されます。
つまり、Windowsが起動するときに立ち上がるよう設定しなくてもいいということです（また、そうすることは安全性の観点から推奨しません）。</p>

<p>Windows
95/98ではテストしていません（まだ使ってる人いるの？）。そして、もしもWin95/98で完全に動くのであればとても驚きです。もし動いたら教えてください。</p>

<p>最後に、これがソースコードです。</p>

<p><a href="gcpad1.cpp">gcpad1.cpp</a></p>

<p>これはMS Visual Studio
.NETのコンソールプロジェクトとしてコンパイルしています。たぶんVC++6でも動きます。
MS独自の構文のインラインアセンブラを使っていますが、他のコンパイラ用に書き直すのは簡単でしょう。</p>

<h4 id="section-16">次にやること</h4>

<p>最初にやるべきことは、ハードウエアを改良して、いろいろなPCでテストすることです。最小必須環境としては、P3
1GHzあたりを見ています。
ソフトウエアも改良が必要です。ハードウエアと対話するためのカーネルモードのデバイスドライバと、ジョイスティックとして扱うためのDirectInputドライバが必要です。
二つ以上のコントローラーが使えるとなお良いです。今のシフトレジスタは2入力なので、二つ目のコントローラをサポートするのはそう難しくないでしょう。</p>

<p>Philipp
KastnerとPICマイコンを使ったインターフェースができるかどうか議論しました。これは、シリアルやUSBインターフェースの開発を可能にします。
一つの障害は、USB機能のあるPICは紫外線でメモリを消去するものしかない（フラッシュメモリのものは無い）ということです。
また当然ですが、不幸にも誰もがPICプログラマーを持っているとは限りません。
しかし、PICを使えば一つのインターフェースで複数のコントローラーが扱えるはずです。ゲームキューブみたいに、4ポートのパネルが作れればどんなにいいことか・・・。</p>

<p>そして、PCの古いゲームがあれば・・・。でも退屈な古い3人称視点シューティングはお断り。</p>

<h4 id="section-17">クレジット</h4>

<p>長いこと放置していたこの研究を、もう一度行うきっかけをくれたPhilipp
Kastnerに多大なる感謝を
（この研究と、そしてもちろん、友達であるゼルダ、リンク、マリオには、多くの時間を割かせたことで非難を）。</p>

<p>シフトレジスタの設計は、Stephan Hans、Simon
Nield、F.P.Earle他によって始められたNintendo
64コントローラー用インターフェースの
プロジェクトが大いに参考になりました。ありがとう！</p>

<p>GC
Linuxプロジェクトは間違いなく一見の価値があります。コントローラーのコマンド詳細のうち一部は、彼らの文書から頂きました（YAGCDで検索）
<sup id="fnref:4"><a href="#fn:4" class="footnote">4</a></sup> ．</p>

<p>去年からメールをくれた多くの人たち。全員の名前は覚えていませんが、古いメールが見つかったらみんな載せます！</p>

<p>配線や、ピカピカ光るライトや、至る所散らかった工具に我慢してくれたSaraにも感謝を
:)</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p><a href="http://www.int03.co.uk/crema/">元ページindex</a> のContact <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>(訳注：日本ではホームセンターに行けば売っていると思います．もしくは秋葉原とか) <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>(訳注： <a href="http://ja.wikipedia.org/wiki/PAL">アナログテレビの規格</a> ) <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:4">
      <p>(訳注： <a href="http://www.gc-linux.org/docs/yagcd.html">Yet Another GameCube
Documentation</a>
と思われますが、なぜか消えてるぽいです) <a href="#fnref:4" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>
 
    
        <div id="kogarasi-hardware-gc-control_ja" class="kogarasi-mark">ここにはかつてコメントが表示されていました</div>
    
  </div>
</div>
<div id="footer">
  <p>Last update: 2013-10-17 02:38:57</p>
</div>

</body>
</html>
